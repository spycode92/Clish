<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.itwillbs.clish.myPage.mapper.PaymentMapper">
	<!-- 결제정보 삽입 -->
	<insert id="insertPayInfo">
	<selectKey keyProperty="classTitle" resultType="String" order="BEFORE">
		SELECT c.class_title
		FROM CLASS c
		JOIN RESERVATION r
		ON r.class_idx = c.class_idx
		where r.reservation_idx = #{reservationIdx}
		
	</selectKey>
		insert into PAYMENT_INFO values(
			#{impUid}
		    , #{reservationIdx}
		    , #{classTitle}
		    , #{amount}
		    , #{status}
		    , #{userName}
		    , #{payMethod}
		    , #{requestTime}
		    , #{payTime}
		    , #{failReason}
		    , #{failTime}
		    , #{receiptUrl}
		); 
	</insert>
	<!-- 예약정보 업데이트(결제완료) -->
	<update id="updateReservationStatus">
		UPDATE RESERVATION
		SET reservation_status = 2
		WHERE reservation_idx = #{reservationIdx}
	</update>
	
	<!-- 결제정보 불러오기 -->
	<select id="selectPayResult" resultType="com.itwillbs.clish.myPage.dto.PaymentInfoDTO">	
		SELECT *
		from PAYMENT_INFO
		where imp_uid = #{impUid}
	</select>
	
	<!-- 결제 취소 정보 삽입 -->
	<insert id="insertCancelInfo">
		insert into PAYMENT_CANCEL values(
			#{impUid}
			, #{reservationIdx}
			, #{classTitle}
			, #{amount}
			, #{cancelAmount}
			, #{status}
			, #{cancelReason}
			, #{cancelledAt}
			, #{userName}
			, #{payMethod}
			, #{receiptUrl}
			, #{cancelRequestTime}
			, #{cancelReceiptUrl}
		)
	</insert>
	<!-- 결제 정보 업데이트(결제취소) -->
	<update id="updatePaymentInfo">
		update PAYMENT_INFO
		set status = #{status}
		where imp_uid = #{impUid}		
	</update>
	<!--  결제취소정보 불러오기 -->
	<select id="selectCancelResult" resultType="com.itwillbs.clish.myPage.dto.PaymentCancelDTO">
		select *
		from 
			PAYMENT_CANCEL
		WHERE
			imp_uid = #{impUid}
	</select>
	
	<!-- 결제 취소폼 실행 필요 정보 -->
	<resultMap type="map" id="beforeCancelInfo">
		<id property="impUid" column="imp_uid" />
		<result property="classTitle" column="class_title" />
		<result property="reservationIdx" column="reservation_idx" />
		<result property="amount" column="amount" />
		<result property="userName" column="user_name" />
		<result property="status" column="status" />
		<result property="payTime" column="pay_time" />
		<result property="classType" column="class_type" />
		<result property="reservationClassDate" column="reservation_class_date"/>
	</resultMap>
	<!-- 결제정보 불러오기 -->
	<select id="selectCancelBefore" resultMap="beforeCancelInfo">	
		SELECT p.*
			, r.reservation_class_date
			, c.class_type
		from PAYMENT_INFO p
		JOIN RESERVATION r
			ON p.reservation_idx = r.reservation_idx
		JOIN CLASS c
			ON c.class_idx = r.class_idx
		where p.imp_uid = #{impUid}
	</select>
</mapper>