<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwillbs.clish.admin.mapper.AdminPaymentMapper">
	<!-- 결제 리스트 -->
	<select id="selectPaymentList" resultType="map">
		SELECT
			p.imp_uid
			, p.class_title
			, p.amount
			, p.status
			, p.user_name
			, FROM_UNIXTIME(p.pay_time / 1000, '%Y-%m-%d') AS formatted_pay_time
			, p.receipt_url
		FROM
			PAYMENT_INFO p 
		JOIN
			RESERVATION r
		ON
			p.reservation_idx = r.reservation_idx
		JOIN
			CLASS c
		ON
			r.class_idx = c.class_idx
		WHERE
		<choose>
			<when test="filter != null and filter == 'long'">
			c.class_type = 0
			</when>
			<when test="filter != null and filter == 'short'">
			c.class_type = 1
			</when>
			<otherwise>
			1 = 1
			</otherwise>
		</choose>
		ORDER BY 
			<choose>
				<when test="filter != null and filter == 'recent'">
					p.pay_time DESC
				</when>
				<when test="filter != null and filter == 'oldest'">
					p.pay_time ASC
				</when>
				<otherwise>
					p.pay_time DESC
				</otherwise>
			</choose>
		LIMIT
			#{startRow}     
			, #{listLimit} 
	</select>
	
	<!-- 모든 결제 내역 수 -->
	<select id="selectPaymentCount" resultType="int">
		SELECT
			COUNT(p.imp_uid)
		FROM
			PAYMENT_INFO p 
		JOIN
			RESERVATION r
		ON
			p.reservation_idx = r.reservation_idx
		JOIN
			CLASS c
		ON
			r.class_idx = c.class_idx
		WHERE
		<choose>
			<when test="filter != null and filter == 'long'">
			c.class_type = 0
			</when>
			<when test="filter != null and filter == 'short'">
			c.class_type = 1
			</when>
			<otherwise>
			1 = 1
			</otherwise>
		</choose>
	</select>
</mapper>  
  
  
  
  
  
  
  
  
  
  
  